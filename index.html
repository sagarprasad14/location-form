<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Location Collection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 14px;
    }
    input[readonly] {
      background-color: #f2f2f2;
      cursor: not-allowed;
    }
    button {
      background: #2e7d32;
      color: white;
      border: none;
      cursor: pointer;
    }
    button.secondary {
      background: #1565c0;
    }
  </style>
</head>

<body>

<h2>Location Details</h2>

<!-- Manual Inputs -->
<input id="name" placeholder="Enter Name" required />
<input id="nodeId" placeholder="Enter Node ID" required />

<!-- Location Button -->
<button class="secondary" onclick="getLocation()">üìç Use My Location</button>

<!-- Auto-filled (Non-editable) -->
<input id="lat" placeholder="Latitude" readonly />
<input id="lon" placeholder="Longitude" readonly />
<input id="city" placeholder="City" readonly />
<input id="state" placeholder="State" readonly />
<input id="pincode" placeholder="Pincode" readonly />

<!-- Submit -->
<button onclick="submitData()">Submit</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl7EgQBvnCEFxi1Hz7IHrMh1FSNnE19Gx6XKFAZcIspdDpRNAK1V5HQFAswLN8-F8GDw/exec";
let locationReady = false;

function getLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  locationReady = false;

  navigator.geolocation.getCurrentPosition(
    async position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      document.getElementById("lat").value = lat;
      document.getElementById("lon").value = lon;

      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      const res = await fetch(url);
      const data = await res.json();

      document.getElementById("city").value =
        data.address.city ||
        data.address.town ||
        data.address.village ||
        "";

      document.getElementById("state").value = data.address.state || "";
      document.getElementById("pincode").value = data.address.postcode || "";

      locationReady = true;
      alert("üìç Location captured successfully");
    },
    error => {
      alert("‚ùå Unable to fetch location");
      console.error(error);
    }
  );
}

async function submitData() {
  if (!locationReady) {
    alert("Please click 'Use My Location' first");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const nodeId = document.getElementById("nodeId").value.trim();

  if (!name || !nodeId) {
    alert("Please enter Name and Node ID");
    return;
  }

  const latitude = document.getElementById("lat").value;
  const longitude = document.getElementById("lon").value;

  if (!latitude || !longitude) {
    alert("Location not ready yet. Please wait.");
    return;
  }

  const payload = {
    name,
    nodeId,
    latitude,
    longitude,
    city: document.getElementById("city").value,
    state: document.getElementById("state").value,
    pincode: document.getElementById("pincode").value,
    userAgent: navigator.userAgent
  };

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (result.status === "success") {
    alert("‚úÖ Submitted successfully");
  } else {
    alert("‚ùå Submission failed");
  }
}
</script>


</body>
</html>
